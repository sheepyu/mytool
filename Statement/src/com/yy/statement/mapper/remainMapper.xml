<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yy.statement.mapper.remainMapper">

	<select id="getRemain" resultType="Remain">
		select  dlm,dlmc,zjye,x.expendDay,expendWeek,floor((zjye/expendWeek)*7) as canUse from (
		select dlid,sum(zje)/100 as expendWeek,--一周使用金额
		(select sum(zje)/100 from tj_dldx b where a.dlid=b.dlid and tjrq>=to_char(sysdate-1,'yyyymmdd') group by dlid) as expendDay,--昨日使用金额
		(select zjye/100 from tj_dl c where  tjrq>=to_char(sysdate-1,'yyyymmdd') and zjye<400000 and a.dlid=c.dlid) as zjye--资金余额
		from tj_dldx a where tjrq>=to_char(sysdate-7,'yyyymmdd') group by dlid) x,xx_dl y 
		where zjye is not null and x.dlid=y.dlid and (zjye/expendWeek)<5 and dlm!='app' order by dlm
	</select>
</mapper>


